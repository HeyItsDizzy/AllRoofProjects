[1mdiff --git a/.gitignore b/.gitignore[m
[1mindex fed212f..0d12252 100644[m
[1m--- a/.gitignore[m
[1m+++ b/.gitignore[m
[36m@@ -64,3 +64,23 @@[m [mFrontend/.env[m
 X/[m
 backup/[m
 Backend/apikeys.json[m
[32m+[m[32mBackend/*.env[m
[32m+[m[32mFront End 1st Live 02-07-2025.zip[m
[32m+[m[32mBackend/.env[m
[32m+[m[32mBackend_old_*/[m
[32m+[m[32m# any -backup-*.tar.gz files[m
[32m+[m[32m*-backup-*.tar.gz[m
[32m+[m[32m# local ZIP artifacts[m
[32m+[m[32m*.zip[m
[32m+[m[32mBackend/.FM/[m
[32m+[m[32m**/.FM/[m
[32m+[m
[32m+[m[32m# dependencies[m
[32m+[m[32m/node_modules/[m
[32m+[m[32m/Frontend/node_modules/[m
[32m+[m[32m/Backend/node_modules/[m
[32m+[m
[32m+[m[32m# dependencies[m
[32m+[m[32m/node_modules/[m
[32m+[m[32m/Frontend/node_modules/[m
[32m+[m[32m/Backend/node_modules/[m
[1mdiff --git a/Backend/db.js b/Backend/db.js[m
[1mindex 0c082b5..53695a5 100644[m
[1m--- a/Backend/db.js[m
[1m+++ b/Backend/db.js[m
[36m@@ -1,64 +1,64 @@[m
[31m-// db.js[m
[31m-const { MongoClient } = require("mongodb");[m
[31m-[m
[31m-let client;[m
[31m-let db;[m
[31m-[m
[31m-// Connect to MongoDB with error handling[m
[31m-const connectDB = async () => {[m
[31m-  const uri = process.env.MONGODB_URI;[m
[31m-  //console.log("‚ñ∂Ô∏è MONGODB_URI:", uri);[m
[31m-[m
[31m-  // Check if the MongoDB URI is set[m
[31m-  if (!uri) {[m
[31m-    throw new Error("MONGODB_URI is not set in the environment variables.");[m
[31m-  }[m
[31m-[m
[31m-  try {[m
[31m-    if (!client) {[m
[31m-      client = new MongoClient(uri);[m
[31m-[m
[31m-[m
[31m-      // Attempt connection[m
[31m-      await client.connect();[m
[31m-      console.log("Connected to MongoDB!");[m
[31m-      const dbName = process.env.DB_NAME || "ART";[m
[31m-db = client.db(dbName);[m
[31m-[m
[31m-    }[m
[31m-[m
[31m-    return db;[m
[31m-  } catch (error) {[m
[31m-    console.error("Error connecting to MongoDB:", error.message);[m
[31m-    throw new Error("Failed to connect to MongoDB. Please check the URI and network connectivity.");[m
[31m-  }[m
[31m-};[m
[31m-[m
[31m-// Access the users collection with error handling[m
[31m-const userCollection = async () => {[m
[31m-  try {[m
[31m-    const database = await connectDB();[m
[31m-    console.log("Accessing Users collection");[m
[31m-    return database.collection("Users"); // Ensure correct case sensitivity[m
[31m-  } catch (error) {[m
[31m-    console.error("Error accessing Users collection:", error.message);[m
[31m-    throw new Error("Failed to access Users collection.");[m
[31m-  }[m
[31m-};[m
[31m-[m
[31m-// Access the projects collection with error handling[m
[31m-const projectsCollection = async () => {[m
[31m-  try {[m
[31m-    const database = await connectDB();[m
[31m-    console.log("Accessing Projects collection");[m
[31m-    const collection = database.collection("Projects");[m
[31m-    console.log("‚úÖ Projects collection accessed successfully!");[m
[31m-    return collection;[m
[31m-  } catch (error) {[m
[31m-    console.error("Error accessing Projects collection:", error.message);[m
[31m-    throw new Error("Failed to access Projects collection.");[m
[31m-  }[m
[31m-};[m
[31m-[m
[31m-[m
[31m-module.exports = { userCollection, projectsCollection };[m
[32m+[m[32m// db.js[m
[32m+[m[32mconst { MongoClient } = require("mongodb");[m
[32m+[m
[32m+[m[32mlet client;[m
[32m+[m[32mlet db;[m
[32m+[m
[32m+[m[32m// Connect to MongoDB with error handling[m
[32m+[m[32mconst connectDB = async () => {[m
[32m+[m[32m  const uri = process.env.MONGODB_URI;[m
[32m+[m[32m  //console.log("‚ñ∂Ô∏è MONGODB_URI:", uri);[m
[32m+[m
[32m+[m[32m  // Check if the MongoDB URI is set[m
[32m+[m[32m  if (!uri) {[m
[32m+[m[32m    throw new Error("MONGODB_URI is not set in the environment variables.");[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  try {[m
[32m+[m[32m    if (!client) {[m
[32m+[m[32m      client = new MongoClient(uri);[m
[32m+[m
[32m+[m
[32m+[m[32m      // Attempt connection[m
[32m+[m[32m      await client.connect();[m
[32m+[m[32m      console.log("Connected to MongoDB!");[m
[32m+[m[32m      const dbName = process.env.DB_NAME || "ART";[m
[32m+[m[32mdb = client.db(dbName);[m
[32m+[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return db;[m
[32m+[m[32m  } catch (error) {[m
[32m+[m[32m    console.error("Error connecting to MongoDB:", error.message);[m
[32m+[m[32m    throw new Error("Failed to connect to MongoDB. Please check the URI and network connectivity.");[m
[32m+[m[32m  }[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m// Access the users collection with error handling[m
[32m+[m[32mconst userCollection = async () => {[m
[32m+[m[32m  try {[m
[32m+[m[32m    const database = await connectDB();[m
[32m+[m[32m    console.log("Accessing Users collection");[m
[32m+[m[32m    return database.collection("Users"); // Ensure correct case sensitivity[m
[32m+[m[32m  } catch (error) {[m
[32m+[m[32m    console.error("Error accessing Users collection:", error.message);[m
[32m+[m[32m    throw new Error("Failed to access Users collection.");[m
[32m+[m[32m  }[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32m// Access the projects collection with error handling[m
[32m+[m[32mconst projectsCollection = async () => {[m
[32m+[m[32m  try {[m
[32m+[m[32m    const database = await connectDB();[m
[32m+[m[32m    console.log("Accessing Projects collection");[m
[32m+[m[32m    const collection = database.collection("Projects");[m
[32m+[m[32m    console.log("‚úÖ Projects collection accessed successfully!");[m
[32m+[m[32m    return collection;[m
[32m+[m[32m  } catch (error) {[m
[32m+[m[32m    console.error("Error accessing Projects collection:", error.message);[m
[32m+[m[32m    throw new Error("Failed to access Projects collection.");[m
[32m+[m[32m  }[m
[32m+[m[32m};[m
[32m+[m
[32m+[m
[32m+[m[32mmodule.exports = { userCollection, projectsCollection };[m
[1mdiff --git a/Backend/features/Backend File Manager_folder-tree.txt b/Backend/features/Backend File Manager_folder-tree.txt[m
[1mnew file mode 100644[m
[1mindex 0000000..89093f7[m
[1m--- /dev/null[m
[1m+++ b/Backend/features/Backend File Manager_folder-tree.txt[m	
[36m@@ -0,0 +1,5 @@[m
[32m+[m[32m  fileManager[m
[32m+[m[32m    controllers[m
[32m+[m[32m    models[m
[32m+[m[32m    routes[m
[32m+[m[32m    services[m
[1mdiff --git a/Backend/features/fileManager/controllers/fileController.js b/Backend/features/fileManager/controllers/fileController.js[m
[1mindex 0b5e8df..2e3098a 100644[m
[1m--- a/Backend/features/fileManager/controllers/fileController.js[m
[1m+++ b/Backend/features/fileManager/controllers/fileController.js[m
[36m@@ -1,30 +1,128 @@[m
[32m+[m[32m//fileController.js (Debugging Enhanced)[m
 const path = require("path");[m
 const fs = require("fs");[m
 const { uploadsRoot: root } = require("../services/pathUtils");[m
[32m+[m[32mconst { ObjectId } = require("mongodb");[m
[32m+[m[32mconst { projectsCollection } = require("../../../db");[m
[32m+[m[32mconst { getProjectUploadPath } = require("../services/pathUtils");[m
 [m
[31m-const downloadFile = async (req, res) => {[m
[32m+[m[32mconst multer = require("multer");[m
[32m+[m[32mconst { fromBuffer } = require("file-type");[m
[32m+[m[32mconst { allowedExtensions } = require("../../../middleware/extensionLoader");[m
[32m+[m
[32m+[m
[32m+[m[32mconst storage = multer.memoryStorage();[m
[32m+[m[32mconst upload = multer({ storage });[m
[32m+[m
[32m+[m[32mconst uploadFiles = [[m
[32m+[m[32m  upload.array("files"),[m
[32m+[m[32m  async (req, res) => {[m
[32m+[m[32m    try {[m
[32m+[m[32m      const { projectId } = req.params;[m
[32m+[m[32m      const files = req.files;[m
[32m+[m[32m      const folderPath = req.body.folderPath || "";[m
[32m+[m
[32m+[m[32m      if (!files?.length) {[m
[32m+[m[32m        return res.status(400).json({ error: "No files uploaded." });[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      const collection = await projectsCollection();[m
[32m+[m[32m      const project = await collection.findOne({ _id: new ObjectId(projectId) });[m
[32m+[m[32m      if (!project) return res.status(404).json({ error: "Project not found." });[m
[32m+[m
[32m+[m[32m      const basePath = await getProjectUploadPath(project);[m
[32m+[m[32m      const allowed = allowedExtensions();[m
[32m+[m
[32m+[m[32m      for (const file of files) {[m
[32m+[m[32m        const buffer = file.buffer;[m
[32m+[m[32m        const originalExt = path.extname(file.originalname).toLowerCase();[m
[32m+[m
[32m+[m[32m        const detected = await fromBuffer(buffer);[m
[32m+[m[32m        const mimeExt = detected?.ext ? `.${detected.ext}` : "";[m
[32m+[m
[32m+[m[32m        const mimeAllowed =[m
[32m+[m[32m          allowed.includes(mimeExt) ||[m
[32m+[m[32m          (allowed.includes(originalExt) && allowed.includes(mimeExt));[m
[32m+[m
[32m+[m[32m        if (!mimeAllowed) {[m
[32m+[m[32m          return res.status(400).json({[m
[32m+[m[32m            error: `‚ùå File type not allowed or mismatched: ${originalExt} ‚â† ${mimeExt}`,[m
[32m+[m[32m          });[m
[32m+[m[32m        }[m
[32m+[m
[32m+[m[32m        const fullPath = path.join(basePath, folderPath, file.originalname);[m
[32m+[m[32m        fs.writeFileSync(fullPath, buffer);[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      res.status(200).json({ message: "Files uploaded successfully." });[m
[32m+[m[32m    } catch (err) {[m
[32m+[m[32m      console.error("‚ùå Upload Error:", err);[m
[32m+[m[32m      res.status(500).json({ error: "Upload failed", details: err.message });[m
[32m+[m[32m    }[m
[32m+[m[32m  },[m
[32m+[m[32m];[m
[32m+[m
[32m+[m[32mconst deleteFile = async (req, res) => {[m
   try {[m
[31m-    const { uniqueFileName } = req.params;[m
[31m-    const filePath = path.join(root, uniqueFileName);[m
[32m+[m[32m    const { projectId, filePath } = req.params;[m
 [m
[31m-    if (!fs.existsSync(filePath)) {[m
[31m-      return res.status(404).json({ error: "File not found." });[m
[32m+[m[32m    const collection = await projectsCollection();[m
[32m+[m[32m    const project = await collection.findOne({ _id: new ObjectId(projectId) });[m
[32m+[m[32m    if (!project) return res.status(404).json({ error: "Project not found" });[m
[32m+[m
[32m+[m[32m    const basePath = await getProjectUploadPath(project);[m
[32m+[m[32m    const fullPath = path.join(basePath, filePath);[m
[32m+[m
[32m+[m[32m    console.log("[Delete] Project base path:", basePath);[m
[32m+[m[32m    console.log("[Delete] File relative path:", filePath);[m
[32m+[m[32m    console.log("[Delete] Full resolved path:", fullPath);[m
[32m+[m
[32m+[m[32m    if (!fs.existsSync(fullPath)) {[m
[32m+[m[32m      return res.status(404).json({ error: "File not found" });[m
     }[m
 [m
[31m-    res.download(filePath, uniqueFileName, (err) => {[m
[31m-      if (err) {[m
[31m-        console.error("Error sending file:", err);[m
[31m-        res.status(500).json({ error: "Error downloading file." });[m
[31m-      }[m
[31m-    });[m
[31m-  } catch (error) {[m
[31m-    console.error("Error downloading file:", error);[m
[31m-    res.status(500).json({[m
[31m-      success: false,[m
[31m-      error: "Internal server error.",[m
[31m-      details: error.message,[m
[31m-    });[m
[32m+[m[32m    fs.unlinkSync(fullPath);[m
[32m+[m[32m    res.status(200).json({ message: "File deleted." });[m
[32m+[m[32m  } catch (err) {[m
[32m+[m[32m    console.error("[Delete Error]:", err);[m
[32m+[m[32m    res.status(500).json({ error: "Delete failed", details: err.message });[m
[32m+[m[32m  }[m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mconst renameFile = async (req, res) => {[m
[32m+[m[32m  try {[m
[32m+[m[32m    const { projectId, filePath } = req.params;[m
[32m+[m[32m    const { newName } = req.body;[m
[32m+[m
[32m+[m[32m    const collection = await projectsCollection();[m
[32m+[m[32m    const project = await collection.findOne({ _id: new ObjectId(projectId) });[m
[32m+[m[32m    if (!project) return res.status(404).json({ error: "Project not found" });[m
[32m+[m
[32m+[m[32m    const basePath = await getProjectUploadPath(project);[m
[32m+[m[32m    const oldFullPath = path.join(basePath, filePath);[m
[32m+[m[32m    const baseDir = path.dirname(oldFullPath);[m
[32m+[m[32m    const newFullPath = path.join(baseDir, newName);[m
[32m+[m
[32m+[m[32m    console.log("[Rename] Project base path:", basePath);[m
[32m+[m[32m    console.log("[Rename] File relative path:", filePath);[m
[32m+[m[32m    console.log("[Rename] Old full path:", oldFullPath);[m
[32m+[m[32m    console.log("[Rename] New full path:", newFullPath);[m
[32m+[m
[32m+[m[32m    if (!fs.existsSync(oldFullPath)) {[m
[32m+[m[32m      return res.status(404).json({ error: "Original file not found" });[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    fs.renameSync(oldFullPath, newFullPath);[m
[32m+[m[32m    res.status(200).json({ message: "File renamed." });[m
[32m+[m[32m  } catch (err) {[m
[32m+[m[32m    console.error("[Rename Error]:", err);[m
[32m+[m[32m    res.status(500).json({ error: "Rename failed", details: err.message });[m
   }[m
 };[m
 [m
[31m-module.exports = { downloadFile };[m
[32m+[m
[32m+[m[32mmodule.exports = {[m
[32m+[m[32m  uploadFiles,[m
[32m+[m[32m  deleteFile,[m
[32m+[m[32m  renameFile,[m
[32m+[m[32m};[m
[1mdiff --git a/Backend/features/fileManager/controllers/folderController.js b/Backend/features/fileManager/controllers/folderController.js[m
[1mindex c5f6d81..e1f758f 100644[m
[1m--- a/Backend/features/fileManager/controllers/folderController.js[m
[1m+++ b/Backend/features/fileManager/controllers/folderController.js[m
[36m@@ -3,127 +3,120 @@[m [mconst fs = require("fs");[m
 const path = require("path");[m
 const { ObjectId } = require("mongodb");[m
 const { projectsCollection } = require("../../../db");[m
[32m+[m[32mconst { getProjectUploadPath } = require("../services/pathUtils");[m
 const { buildFolderTreeFromDisk } = require("../services/syncService");[m
[31m-const { getProjectDiskPath, getProjectUploadPath, uploadsRoot: root } = require("../services/pathUtils");[m
[31m-const { createInitialProjectFolders } = require("../services/folderScaffolder");[m
[31m-const Folder = require("../models/Folder");[m
 [m
 [m
[31m-function normalizePathFromDisk(p) {[m
[31m-  return p[m
[31m-    .replace(/\\/g, "/")[m
[31m-    .replace(/\/?children\/?/g, "/")[m
[31m-    .replace(/\/?hasMeta\/?/g, "/")[m
[31m-    .replace(/^\/+/, "")[m
[31m-    .replace(/\/+$/, "")[m
[31m-    .replace(/\/{2,}/g, "/");[m
[31m-}[m
[32m+[m[32m//const { initMeta } = require("../services/metaUtils");[m
 [m
[32m+[m[32m// üîí Global root folders and access rules[m
[32m+[m[32mconst FOLDER_ACCESS_RULES = {[m
[32m+[m[32m  BOQ: ["Admin", "User"],[m
[32m+[m[32m  Admin: ["Admin"],[m
[32m+[m[32m  Estimator: ["Estimator"][m
[32m+[m[32m};[m
[32m+[m
[32m+[m[32mconst RootFolders = Object.keys(FOLDER_ACCESS_RULES);[m
[32m+[m
[32m+[m[32mconst createInitialProjectFolders = (project, region = "AU") => {[m
[32m+[m[32m  const rootPath = getProjectUploadPath(project, region);[m
[32m+[m[32m  const subfolders = RootFolders;[m
[32m+[m
[32m+[m[32m  if (!fs.existsSync(rootPath)) {[m
[32m+[m[32m    fs.mkdirSync(rootPath, { recursive: true });[m
[32m+[m[32m    console.log("üìÅ Created root project folder:", rootPath);[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  const rootMeta = {[m
[32m+[m[32m    projectId: project._id.toString(),[m
[32m+[m[32m    projectNumber: project.projectNumber,[m
[32m+[m[32m    projectName: project.name,[m
[32m+[m[32m    region,[m
[32m+[m[32m    createdAt: new Date().toISOString(),[m
[32m+[m[32m    allowedRoles: FOLDER_ACCESS_RULES,[m
[32m+[m[32m    structure: subfolders[m
[32m+[m[32m  };[m
[32m+[m
[32m+[m[32m  const rootMetaPath = path.join(rootPath, ".meta.json");[m
[32m+[m[32m  fs.writeFileSync(rootMetaPath, JSON.stringify(rootMeta, null, 2));[m
[32m+[m[32m  console.log(`üìù Root .meta.json written: ${rootMetaPath}`);[m
[32m+[m
[32m+[m[32m  for (const folder of subfolders) {[m
[32m+[m[32m    const fullPath = path.join(rootPath, folder);[m
[32m+[m[32m    if (!fs.existsSync(fullPath)) {[m
[32m+[m[32m      fs.mkdirSync(fullPath, { recursive: true });[m
[32m+[m[32m      console.log(`üìÇ Created subfolder: ${fullPath}`);[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  return true;[m
[32m+[m[32m};[m
 [m
 const createFolder = async (req, res) => {[m
   try {[m
[31m-    console.log("üì• Incoming folder creation request");[m
[32m+[m[32m    console.log("üì• Incoming folder create request");[m
 [m
     const { projectId } = req.params;[m
[31m-    const { path: name, role = "all", region = "AU" } = req.body;[m
[32m+[m[32m    const { path: relativePath } = req.body;[m
 [m
[32m+[m[32m    if (!relativePath || typeof relativePath !== "string") {[m
[32m+[m[32m      return res.status(400).json({ error: "Missing or invalid folder path" });[m
[32m+[m[32m    }[m
 [m
     const collection = await projectsCollection();[m
     const project = await collection.findOne({ _id: new ObjectId(projectId) });[m
[32m+[m[32m    if (!project) return res.status(404).json({ error: "Project not found" });[m
 [m
[31m-    if (!project) {[m
[31m-      console.log("‚ùå Project not found:", projectId);[m
[31m-      return res.status(404).json({ error: "Project not found" });[m
[32m+[m[32m    const basePath = await getProjectUploadPath(project);[m
[32m+[m[32m    const newFolderPath = path.join(basePath, relativePath);[m
[32m+[m
[32m+[m[32m    if (fs.existsSync(newFolderPath)) {[m
[32m+[m[32m      return res.status(400).json({ error: "Folder already exists" });[m
     }[m
 [m
[31m-    console.log("üì¶ Matched Project:", project.projectNumber, "-", project.name);[m
[32m+[m[32m    fs.mkdirSync(newFolderPath, { recursive: true });[m
[32m+[m[32m    console.log(`üìÅ Folder created: ${newFolderPath}`);[m
 [m
[31m-    const [yearShort, monthSeq] = project.projectNumber.split("-");[m
[31m-    const fullYear = `20${yearShort}`;[m
[31m-    const monthNum = parseInt(monthSeq.slice(0, 2), 10);[m
[32m+[m[32m    return res.status(200).json({[m
[32m+[m[32m  message: "Folder created successfully",[m
[32m+[m[32m  fullPath: relativePath, // <-- relative to project root, e.g., "Admin/New Folder"[m
[32m+[m[32m});[m
 [m
[31m-    // Localized month name[m
[31m-    const locales = {[m
[31m-      AU: "en-AU",[m
[31m-      US: "en-US",[m
[31m-      NO: "nb-NO",[m
[31m-    };[m
[31m-    const locale = locales[region] || "en";[m
[31m-    const monthName = new Date(2000, monthNum - 1).toLocaleString(locale, { month: "short" });[m
[31m-    const monthFolder = `${monthNum.toString().padStart(2, "0")}. ${monthName.charAt(0).toUpperCase()}${monthName.slice(1)}`;[m
[32m+[m[32m  } catch (err) {[m
[32m+[m[32m    console.error("üî• Error in createFolder:", err);[m
[32m+[m[32m    return res.status(500).json({ error: "Server error", details: err.message });[m
[32m+[m[32m  }[m
[32m+[m[32m};[m
 [m
 [m
[31m-    const fullPath = getProjectDiskPath(project, name, region);[m
[31m-    [m
[31m-    [m
[32m+[m[32mconst deleteFolder = async (req, res) => {[m
[32m+[m[32m  try {[m
[32m+[m[32m    console.log("üì• Incoming folder delete request");[m
 [m
[31m-    console.log("üìÅ Final disk path:", fullPath);[m
[32m+[m[32m    const { projectId, folderId } = req.params;[m
 [m
[31m-    fs.mkdirSync(fullPath, { recursive: true })