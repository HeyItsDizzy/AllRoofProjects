require("dotenv").config();
const { ObjectId } = require("mongodb");
const { projectsCollection } = require("../db");

const cleanupProjects = async () => {
  try {
    const collection = await projectsCollection();
    console.log("‚úÖ Connected to Projects collection!");

    // Fetch all projects
    const projects = await collection.find().toArray();

    for (const project of projects) {
      // ‚úÖ Create a new cleaned version of the project with ONLY the required fields
      const cleanedProject = {
        name: project.name || "",
        location: project.location || "",
        due_date: project.due_date || "",
        posting_date: project.posting_date || new Date().toISOString().split("T")[0], // Ensure ISO format
        linkedUsers: Array.isArray(project.linkedUsers) ? project.linkedUsers : [],
        description: project.description || "",
        subTotal: project.subTotal || 0,
        total: project.total || 0,
        gst: project.gst || 0,
        status: project.status || "running",
        projectNumber: project.projectNumber || "Pending",
        files: Array.isArray(project.files) ? project.files : [],
      };

      // ‚úÖ Completely REPLACE the project with ONLY the required fields
      await collection.replaceOne(
        { _id: new ObjectId(project._id) },
        cleanedProject
      );

      console.log(`‚úÖ Cleaned project ID: ${project._id}`);
    }

    console.log("üéâ All projects have been fully cleaned, and extra fields removed!");
  } catch (error) {
    console.error("‚ùå Error cleaning project data:", error.message);
  }
};

// Run the script
cleanupProjects();
