const fs = require("fs");
const path = require("path");
const { getProjectDiskPath } = require("./pathUtils");
const { moveMeta } = require("./metaUtils");

async function tryRenameProjectFolder(originalProject, updatedProject, region = "AU") {
  const oldPath = getProjectDiskPath(originalProject, "", region);
  const newPath = getProjectDiskPath(updatedProject, "", region);

  if (oldPath === newPath) {
    console.log("üìÇ No rename needed ‚Äî project folder alias unchanged.");
    return { success: true, reason: "No rename needed" };
  }

  try {
    if (!fs.existsSync(oldPath)) {
      console.warn("‚ö†Ô∏è Old folder path does not exist:", oldPath);
      return { success: false, reason: "Original folder not found" };
    }

    if (fs.existsSync(newPath)) {
      console.warn("‚ö†Ô∏è Cannot rename ‚Äî destination folder already exists:", newPath);
      return { success: false, reason: "Destination folder already exists" };
    }

    fs.mkdirSync(path.dirname(newPath), { recursive: true });
    fs.renameSync(oldPath, newPath);
    console.log("‚úÖ Project folder renamed from:\n", oldPath, "\n‚û°Ô∏è to:\n", newPath);

    moveMeta(oldPath, newPath); // ‚úÖ move .meta.json with it

    return { success: true };
  } catch (err) {
    console.error("üî• Error renaming project folder:", err);
    return { success: false, reason: err.message };
  }
}

module.exports = { tryRenameProjectFolder };
