// diskWatcher.js
import chokidar from "chokidar";
import path from "path";
import { syncFromDisk } from "./syncService.js"; // Adjust path if needed


export const changeMap = {}; // Stores latest change timestamps for long polling


const watcherMap = {}; // Holds active watchers keyed by projectId

//Start a watcher on a specific project folder
export const startWatcher = (projectId, fullDiskPath) => {
  if (watcherMap[projectId]) {
    console.log(`ðŸ“¡ Watcher already active for ${projectId}`);
    return;
  }

  console.log(`ðŸ“‚ Starting watcher for projectId: ${projectId}`);
  console.log(`ðŸ“ Target watch path: ${fullDiskPath}`);

  const watcher = chokidar.watch(fullDiskPath, {
    persistent: true,
    ignoreInitial: true,
    depth: 5,
  });

  watcher
    .on("ready", () => {
      console.log(`âœ… Watcher ready for ${projectId}`);
    })
    .on("addDir", (folderPath) => {
      console.log(`ðŸ“ [${projectId}] Folder added: ${folderPath}`);
      syncFromDisk(projectId);
      changeMap[projectId] = Date.now(); // â±ï¸ Update change time
    })
    .on("unlinkDir", (folderPath) => {
      console.log(`âŒ [${projectId}] Folder removed: ${folderPath}`);
      syncFromDisk(projectId);
      changeMap[projectId] = Date.now(); // â±ï¸ Update change time
    });
    

  watcher.on("error", (err) => {
    console.error(`ðŸ’¥ Watcher error for ${projectId}:`, err);
  });

  watcherMap[projectId] = watcher;
  console.log(`ðŸ§  Watcher instance stored for ${projectId}`);
  console.log(`ðŸ“¡ Now watching disk for project: ${projectId}`);
};

//Register a callback to run when disk changes are detected (used for long polling)
export const onDiskChange = (projectId, callback) => {
  const interval = setInterval(() => {
    const lastChange = changeMap[projectId];
    if (lastChange && Date.now() - lastChange < 5000) {
      clearInterval(interval);
      callback(); // Respond immediately
    }
  }, 1000); // check every second

  // Automatically clear after 55s (client timeout fallback)
  setTimeout(() => clearInterval(interval), 55000);
};

//Stop watching a project folder
export const stopWatcher = (projectId) => {
  const watcher = watcherMap[projectId];
  if (watcher) {
    watcher.close();
    delete watcherMap[projectId];
    console.log(`ðŸ›‘ Stopped watching: ${projectId}`);
  }
};

//Check if a project is currently being watched
export const isWatching = (projectId) => {
  return !!watcherMap[projectId];
};
